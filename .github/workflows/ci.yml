name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  validate:
    name: Code Validation
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          # Use the latest available Xcode version
          XCODE_PATH=$(ls -td /Applications/Xcode_*.app | head -1)
          if [ -z "$XCODE_PATH" ]; then
            XCODE_PATH="/Applications/Xcode.app"
          fi
          echo "Using Xcode at: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer"

      - name: Show environment
        run: |
          echo "Xcode version:"
          xcodebuild -version
          echo ""
          echo "Swift version:"
          swift --version

      - name: Check Swift formatting (SwiftLint if available)
        run: |
          if command -v swiftlint &> /dev/null; then
            echo "Running SwiftLint..."
            swiftlint lint --strict
          else
            echo "SwiftLint not installed, skipping..."
          fi
        continue-on-error: true

      - name: Validate project structure
        run: |
          echo "Checking project file..."
          if [ ! -f "OnCallNotify.xcodeproj/project.pbxproj" ]; then
            echo "❌ Project file not found"
            exit 1
          fi
          echo "✓ Project file exists"

          echo ""
          echo "Checking Info.plist..."
          if [ ! -f "OnCallNotify/Info.plist" ]; then
            echo "❌ Info.plist not found"
            exit 1
          fi
          echo "✓ Info.plist exists"

          echo ""
          echo "Checking required Swift files..."
          REQUIRED_FILES=(
            "OnCallNotify/OnCallNotifyApp.swift"
            "OnCallNotify/StatusBarController.swift"
            "OnCallNotify/Models/Models.swift"
            "OnCallNotify/Services/OnCallService.swift"
            "OnCallNotify/Services/KeychainHelper.swift"
            "OnCallNotify/Views/MenuView.swift"
            "OnCallNotify/Views/SettingsView.swift"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Required file not found: $file"
              exit 1
            fi
            echo "✓ $file"
          done

      - name: Check Swift syntax
        run: |
          echo "Checking Swift files for syntax errors..."
          find OnCallNotify -name "*.swift" -type f | while read file; do
            echo "Checking: $file"
            if ! swift -frontend -parse "$file" > /dev/null 2>&1; then
              echo "❌ Syntax error in: $file"
              swift -frontend -parse "$file"
              exit 1
            fi
          done
          echo "✓ All Swift files have valid syntax"

      - name: Analyze code
        run: |
          xcodebuild \
            -project OnCallNotify.xcodeproj \
            -scheme OnCallNotify \
            -configuration Debug \
            analyze \
            CODE_SIGNING_ALLOWED=NO \
            CLANG_ANALYZER_OUTPUT=html \
            CLANG_ANALYZER_OUTPUT_DIR=analyzer-results

      - name: Check for compiler warnings
        run: |
          echo "Building to check for warnings..."
          xcodebuild \
            -project OnCallNotify.xcodeproj \
            -scheme OnCallNotify \
            -configuration Debug \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            clean build 2>&1 | tee build.log

          # Count warnings (excluding layout recursion warnings which are known)
          WARNINGS=$(grep -i "warning:" build.log | grep -v "layout recursion" | wc -l | tr -d ' ')

          echo ""
          echo "Compiler warnings found: $WARNINGS"

          if [ "$WARNINGS" -gt 0 ]; then
            echo ""
            echo "⚠️  Warnings detected:"
            grep -i "warning:" build.log | grep -v "layout recursion"
          fi

      - name: Verify no force unwraps
        run: |
          echo "Checking for force unwraps (!)..."

          # Search for force unwraps, excluding comments
          FORCE_UNWRAPS=$(find OnCallNotify -name "*.swift" -type f -exec grep -n "!" {} + | \
            grep -v "//" | \
            grep -v "!=" | \
            grep -v "ImportantNote" | \
            grep -v "kSecAttrAccessibleAfterFirstUnlock" | \
            wc -l | tr -d ' ')

          if [ "$FORCE_UNWRAPS" -gt 0 ]; then
            echo "⚠️  Found potential force unwraps:"
            find OnCallNotify -name "*.swift" -type f -exec grep -n "!" {} + | \
              grep -v "//" | \
              grep -v "!=" | \
              grep -v "ImportantNote" | \
              grep -v "kSecAttrAccessibleAfterFirstUnlock"
            echo ""
            echo "Note: Force unwraps should be avoided. Use optional binding instead."
          else
            echo "✓ No force unwraps detected"
          fi
        continue-on-error: true

      - name: Check documentation
        run: |
          echo "Checking for required documentation files..."
          DOCS=(
            "README.md"
            "QUICKSTART.md"
            "FEATURES.md"
            "TROUBLESHOOTING.md"
            "CHANGELOG.md"
            "LICENSE"
            "CONTRIBUTING.md"
            "AGENTS.md"
          )

          for doc in "${DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "⚠️  Missing: $doc"
            else
              echo "✓ $doc"
            fi
          done

      - name: Validation summary
        if: always()
        run: |
          echo "## CI Validation Summary ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Swift Syntax**: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- **Project Structure**: Validated" >> $GITHUB_STEP_SUMMARY
          echo "- **Static Analysis**: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Check**: Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment" >> $GITHUB_STEP_SUMMARY
          echo "- **Xcode**: $(xcodebuild -version | head -n 1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Swift**: $(swift --version | head -n 1)" >> $GITHUB_STEP_SUMMARY
          echo "- **macOS**: $(sw_vers -productVersion)" >> $GITHUB_STEP_SUMMARY
